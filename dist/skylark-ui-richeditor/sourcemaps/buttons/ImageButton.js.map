{"version":3,"sources":["buttons/ImageButton.js"],"names":["define","langx","$","Toolbar","RichEditor","Button","ImagePopover","ImageButton","inherit","prototype","name","icon","htmlTag","disableTag","defaultImage","needFocus","_init","item","k","len","ref","_this","this","editor","opts","imageButton","Array","isArray","menu","length","push","text","_t","uploader","body","on","e","$img","range","currentTarget","document","createRange","selectNode","editable","selection","util","support","onselectionchange","trigger","$contents","cloneContents","contents","is","startContainer","eq","startOffset","popover","show","hide","$masks","wrapper","find","each","i","mask","$mask","file","data","parent","remove","cancel","call","render","args","arguments","slice","apply","button","_initUploader","el","renderMenu","$uploadItem","$input","createInput","uploadProgress","menuEl","type","title","multiple","accept","appendTo","stopPropagation","inputManager","focused","upload","inline","one","focus","removeClass","img","createImage","addClass","readImageFile","obj","src","hasClass","loadImage","active","refresh","srcEl","val","prop","proxy","throttle","loaded","total","percent","toFixed","height","result","img_path","msg","JSON","parse","_error","success","alert","file_path","removeData","xhr","statusText","responseText","_status","_disableStatus","callback","positionMask","imgOffset","wrapperOffset","offset","css","top","left","width","Image","onload","attr","data-image-size","reflow","isFunction","onerror","deleteContents","insertNode","setRangeAfter","command","click","select","addButton"],"mappings":"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","file":"../../buttons/ImageButton.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-utils-dom/query\",\r\n  \"../Toolbar\",\r\n  \"../RichEditor\",\r\n  \"../Button\",\r\n  \"./ImagePopover\"\r\n],function(langx, $,Toolbar,RichEditor,Button,ImagePopover){ \r\n   var ImageButton = Button.inherit({\r\n\r\n   });\r\n\r\n\r\n  ImageButton.prototype.name = 'image';\r\n\r\n  ImageButton.prototype.icon = 'picture-o';\r\n\r\n  ImageButton.prototype.htmlTag = 'img';\r\n\r\n  ImageButton.prototype.disableTag = 'pre, table';\r\n\r\n  ImageButton.prototype.defaultImage = '';\r\n\r\n  ImageButton.prototype.needFocus = false;\r\n\r\n  ImageButton.prototype._init = function() {\r\n    var item, k, len, ref;\r\n    if (this.editor.opts.imageButton) {\r\n      if (Array.isArray(this.editor.opts.imageButton)) {\r\n        this.menu = [];\r\n        ref = this.editor.opts.imageButton;\r\n        for (k = 0, len = ref.length; k < len; k++) {\r\n          item = ref[k];\r\n          this.menu.push({\r\n            name: item + '-image',\r\n            text: this._t(item + 'Image')\r\n          });\r\n        }\r\n      } else {\r\n        this.menu = false;\r\n      }\r\n    } else {\r\n      if (this.editor.uploader != null) {\r\n        this.menu = [\r\n          {\r\n            name: 'upload-image',\r\n            text: this._t('uploadImage')\r\n          }, {\r\n            name: 'external-image',\r\n            text: this._t('externalImage')\r\n          }\r\n        ];\r\n      } else {\r\n        this.menu = false;\r\n      }\r\n    }\r\n    this.defaultImage = this.editor.opts.defaultImage;\r\n    this.editor.body.on('click', 'img:not([data-non-image])', (function(_this) {\r\n      return function(e) {\r\n        var $img, range;\r\n        $img = $(e.currentTarget);\r\n        range = document.createRange();\r\n        range.selectNode($img[0]);\r\n        _this.editor.editable.selection.range(range);\r\n        if (!_this.editor.editable.util.support.onselectionchange) {\r\n          _this.editor.trigger('selectionchanged');\r\n        }\r\n        return false;\r\n      };\r\n    })(this));\r\n    this.editor.body.on('mouseup', 'img:not([data-non-image])', function(e) {\r\n      return false;\r\n    });\r\n    this.editor.on('selectionchanged.image', (function(_this) {\r\n      return function() {\r\n        var $contents, $img, range;\r\n        range = _this.editor.editable.selection.range();\r\n        if (range == null) {\r\n          return;\r\n        }\r\n        $contents = $(range.cloneContents()).contents();\r\n        if ($contents.length === 1 && $contents.is('img:not([data-non-image])')) {\r\n          $img = $(range.startContainer).contents().eq(range.startOffset);\r\n          return _this.popover.show($img);\r\n        } else {\r\n          return _this.popover.hide();\r\n        }\r\n      };\r\n    })(this));\r\n    this.editor.on('valuechanged.image', (function(_this) {\r\n      return function() {\r\n        var $masks;\r\n        $masks = _this.editor.wrapper.find('.richeditor-image-loading');\r\n        if (!($masks.length > 0)) {\r\n          return;\r\n        }\r\n        return $masks.each(function(i, mask) {\r\n          var $img, $mask, file;\r\n          $mask = $(mask);\r\n          $img = $mask.data('img');\r\n          if (!($img && $img.parent().length > 0)) {\r\n            $mask.remove();\r\n            if ($img) {\r\n              file = $img.data('file');\r\n              if (file) {\r\n                _this.editor.uploader.cancel(file);\r\n                if (_this.editor.body.find('img.uploading').length < 1) {\r\n                  return _this.editor.uploader.trigger('uploadready', [file]);\r\n                }\r\n              }\r\n            }\r\n          }\r\n        });\r\n      };\r\n    })(this));\r\n    return Button.prototype._init.call(this);\r\n  };\r\n\r\n  ImageButton.prototype.render = function() {\r\n    var args;\r\n    args = 1 <= arguments.length ? Array.prototype.slice.call(arguments, 0) : [];\r\n    Button.prototype.render.apply(this, args);\r\n    this.popover = new ImagePopover({\r\n      button: this\r\n    });\r\n    if (this.editor.opts.imageButton === 'upload') {\r\n      return this._initUploader(this.el);\r\n    }\r\n  };\r\n\r\n  ImageButton.prototype.renderMenu = function() {\r\n    Button.prototype.renderMenu.call(this);\r\n    return this._initUploader();\r\n  };\r\n\r\n  ImageButton.prototype._initUploader = function($uploadItem) {\r\n    var $input, createInput, uploadProgress;\r\n    if ($uploadItem == null) {\r\n      $uploadItem = this.menuEl.find('.menu-item-upload-image');\r\n    }\r\n    if (this.editor.uploader == null) {\r\n      this.el.find('.btn-upload').remove();\r\n      return;\r\n    }\r\n    $input = null;\r\n    createInput = (function(_this) {\r\n      return function() {\r\n        if ($input) {\r\n          $input.remove();\r\n        }\r\n        return $input = $('<input/>', {\r\n          type: 'file',\r\n          title: _this._t('uploadImage'),\r\n          multiple: true,\r\n          accept: 'image/gif,image/jpeg,image/jpg,image/png,image/svg'\r\n        }).appendTo($uploadItem);\r\n      };\r\n    })(this);\r\n    createInput();\r\n    $uploadItem.on('click mousedown', 'input[type=file]', function(e) {\r\n      return e.stopPropagation();\r\n    });\r\n    $uploadItem.on('change', 'input[type=file]', (function(_this) {\r\n      return function(e) {\r\n        if (_this.editor.editable.inputManager.focused) {\r\n          _this.editor.uploader.upload($input, {\r\n            inline: true\r\n          });\r\n          createInput();\r\n        } else {\r\n          _this.editor.one('focus', function(e) {\r\n            _this.editor.uploader.upload($input, {\r\n              inline: true\r\n            });\r\n            return createInput();\r\n          });\r\n          _this.editor.focus();\r\n        }\r\n        return _this.wrapper.removeClass('menu-on');\r\n      };\r\n    })(this));\r\n    this.editor.uploader.on('beforeupload', (function(_this) {\r\n      return function(e, file) {\r\n        var $img;\r\n        if (!file.inline) {\r\n          return;\r\n        }\r\n        if (file.img) {\r\n          $img = $(file.img);\r\n        } else {\r\n          $img = _this.createImage(file.name);\r\n          file.img = $img;\r\n        }\r\n        $img.addClass('uploading');\r\n        $img.data('file', file);\r\n        return _this.editor.uploader.readImageFile(file.obj, function(img) {\r\n          var src;\r\n          if (!$img.hasClass('uploading')) {\r\n            return;\r\n          }\r\n          src = img ? img.src : _this.defaultImage;\r\n          return _this.loadImage($img, src, function() {\r\n            if (_this.popover.active) {\r\n              _this.popover.refresh();\r\n              return _this.popover.srcEl.val(_this._t('uploading')).prop('disabled', true);\r\n            }\r\n          });\r\n        });\r\n      };\r\n    })(this));\r\n    uploadProgress = langx.proxy(this.editor.editable.util.throttle(function(e, file, loaded, total) {\r\n      var $img, $mask, percent;\r\n      if (!file.inline) {\r\n        return;\r\n      }\r\n      $mask = file.img.data('mask');\r\n      if (!$mask) {\r\n        return;\r\n      }\r\n      $img = $mask.data('img');\r\n      if (!($img.hasClass('uploading') && $img.parent().length > 0)) {\r\n        $mask.remove();\r\n        return;\r\n      }\r\n      percent = loaded / total;\r\n      percent = (percent * 100).toFixed(0);\r\n      if (percent > 99) {\r\n        percent = 99;\r\n      }\r\n      return $mask.find('.progress').height((100 - percent) + \"%\");\r\n    }, 500), this);\r\n    this.editor.uploader.on('uploadprogress', uploadProgress);\r\n    this.editor.uploader.on('uploadsuccess', (function(_this) {\r\n      return function(e, file, result) {\r\n        var $img, img_path, msg;\r\n        if (!file.inline) {\r\n          return;\r\n        }\r\n        $img = file.img;\r\n        if (!($img.hasClass('uploading') && $img.parent().length > 0)) {\r\n          return;\r\n        }\r\n        if (typeof result !== 'object') {\r\n          try {\r\n            result = JSON.parse(result);\r\n          } catch (_error) {\r\n            e = _error;\r\n            result = {\r\n              success: false\r\n            };\r\n          }\r\n        }\r\n        if (result.success === false) {\r\n          msg = result.msg || _this._t('uploadFailed');\r\n          alert(msg);\r\n          img_path = _this.defaultImage;\r\n        } else {\r\n          img_path = result.file_path;\r\n        }\r\n        _this.loadImage($img, img_path, function() {\r\n          var $mask;\r\n          $img.removeData('file');\r\n          $img.removeClass('uploading').removeClass('loading');\r\n          $mask = $img.data('mask');\r\n          if ($mask) {\r\n            $mask.remove();\r\n          }\r\n          $img.removeData('mask');\r\n          _this.editor.trigger('valuechanged');\r\n          if (_this.editor.body.find('img.uploading').length < 1) {\r\n            return _this.editor.uploader.trigger('uploadready', [file, result]);\r\n          }\r\n        });\r\n        if (_this.popover.active) {\r\n          _this.popover.srcEl.prop('disabled', false);\r\n          return _this.popover.srcEl.val(result.file_path);\r\n        }\r\n      };\r\n    })(this));\r\n    return this.editor.uploader.on('uploaderror', (function(_this) {\r\n      return function(e, file, xhr) {\r\n        var $img, msg, result;\r\n        if (!file.inline) {\r\n          return;\r\n        }\r\n        if (xhr.statusText === 'abort') {\r\n          return;\r\n        }\r\n        if (xhr.responseText) {\r\n          try {\r\n            result = JSON.parse(xhr.responseText);\r\n            msg = result.msg;\r\n          } catch (_error) {\r\n            e = _error;\r\n            msg = _this._t('uploadError');\r\n          }\r\n        }\r\n        $img = file.img;\r\n        if (!($img.hasClass('uploading') && $img.parent().length > 0)) {\r\n          return;\r\n        }\r\n        _this.loadImage($img, _this.defaultImage, function() {\r\n          var $mask;\r\n          $img.removeData('file');\r\n          $img.removeClass('uploading').removeClass('loading');\r\n          $mask = $img.data('mask');\r\n          if ($mask) {\r\n            $mask.remove();\r\n          }\r\n          return $img.removeData('mask');\r\n        });\r\n        if (_this.popover.active) {\r\n          _this.popover.srcEl.prop('disabled', false);\r\n          _this.popover.srcEl.val(_this.defaultImage);\r\n        }\r\n        _this.editor.trigger('valuechanged');\r\n        if (_this.editor.body.find('img.uploading').length < 1) {\r\n          return _this.editor.uploader.trigger('uploadready', [file, result]);\r\n        }\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  ImageButton.prototype._status = function() {\r\n    return this._disableStatus();\r\n  };\r\n\r\n  ImageButton.prototype.loadImage = function($img, src, callback) {\r\n    var $mask, img, positionMask;\r\n    positionMask = (function(_this) {\r\n      return function() {\r\n        var imgOffset, wrapperOffset;\r\n        imgOffset = $img.offset();\r\n        wrapperOffset = _this.editor.wrapper.offset();\r\n        return $mask.css({\r\n          top: imgOffset.top - wrapperOffset.top,\r\n          left: imgOffset.left - wrapperOffset.left,\r\n          width: $img.width(),\r\n          height: $img.height()\r\n        }).show();\r\n      };\r\n    })(this);\r\n    $img.addClass('loading');\r\n    $mask = $img.data('mask');\r\n    if (!$mask) {\r\n      $mask = $('<div class=\"richeditor-image-loading\">\\n  <div class=\"progress\"></div>\\n</div>').hide().appendTo(this.editor.wrapper);\r\n      positionMask();\r\n      $img.data('mask', $mask);\r\n      $mask.data('img', $img);\r\n    }\r\n    img = new Image();\r\n    img.onload = (function(_this) {\r\n      return function() {\r\n        var height, width;\r\n        if (!$img.hasClass('loading') && !$img.hasClass('uploading')) {\r\n          return;\r\n        }\r\n        width = img.width;\r\n        height = img.height;\r\n        $img.attr({\r\n          src: src,\r\n          width: width,\r\n          height: height,\r\n          'data-image-size': width + ',' + height\r\n        }).removeClass('loading');\r\n        if ($img.hasClass('uploading')) {\r\n          _this.editor.editable.util.reflow(_this.editor.body);\r\n          positionMask();\r\n        } else {\r\n          $mask.remove();\r\n          $img.removeData('mask');\r\n        }\r\n        if (langx.isFunction(callback)) {\r\n          return callback(img);\r\n        }\r\n      };\r\n    })(this);\r\n    img.onerror = function() {\r\n      if (langx.isFunction(callback)) {\r\n        callback(false);\r\n      }\r\n      $mask.remove();\r\n      return $img.removeData('mask').removeClass('loading');\r\n    };\r\n    return img.src = src;\r\n  };\r\n\r\n  ImageButton.prototype.createImage = function(name) {\r\n    var $img, range;\r\n    if (name == null) {\r\n      name = 'Image';\r\n    }\r\n    if (!this.editor.editable.inputManager.focused) {\r\n      this.editor.focus();\r\n    }\r\n    range = this.editor.editable.selection.range();\r\n    range.deleteContents();\r\n    this.editor.editable.selection.range(range);\r\n    $img = $('<img/>').attr('alt', name);\r\n    range.insertNode($img[0]);\r\n    this.editor.editable.selection.setRangeAfter($img, range);\r\n    this.editor.trigger('valuechanged');\r\n    return $img;\r\n  };\r\n\r\n  ImageButton.prototype.command = function(src) {\r\n    var $img;\r\n    $img = this.createImage();\r\n    return this.loadImage($img, src || this.defaultImage, (function(_this) {\r\n      return function() {\r\n        _this.editor.trigger('valuechanged');\r\n        _this.editor.editable.util.reflow($img);\r\n        $img.click();\r\n        return _this.popover.one('popovershow', function() {\r\n          _this.popover.srcEl.focus();\r\n          return _this.popover.srcEl[0].select();\r\n        });\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  RichEditor.Toolbar.addButton(ImageButton);\t\r\n\r\n  return ImageButton;\r\n\r\n});"]}