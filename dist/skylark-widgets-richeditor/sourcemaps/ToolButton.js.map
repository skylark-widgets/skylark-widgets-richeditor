{"version":3,"sources":["ToolButton.js"],"names":["define","langx","$","RichEditor","i18n","Evented","inherit","name","get","this","action","icon","title","text","htmlTag","disableTag","menu","editable","_options","active","disabled","needFocus","shortcut","init","opts","toolbar","editor","_init","Button","prototype","_tpl","item","menuWrapper","menuItem","separator","k","len","ref","tag","_this","render","el","on","e","noFocus","param","preventDefault","inputManager","focused","hasClass","focus","wrapper","toggleClass","siblings","removeClass","is","offset","left","outerWidth","css","right","trigger","data","command","btn","currentTarget","body","clipboard","pasting","setActive","setDisabled","hotkeys","add","mousedown","split","length","trim","inArray","formatter","_allowedTags","push","_status","iconClassOf","setIcon","find","addClass","appendTo","list","attr","renderMenu","$menuBtnEl","ref1","results","isArray","menuEl","data-param","_disableStatus","endNodes","startNodes","selection","filter","_activeStatus","endNode","startNode","node","_t","translate"],"mappings":"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","file":"../ToolButton.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-utils-dom/query\",\r\n  \"./RichEditor\",\r\n  \"./i18n\"\r\n],function(langx, $,RichEditor,i18n){ \r\n  var slice = [].slice;\r\n\r\n  var ToolButton = langx.Evented.inherit( {\r\n\r\n    \"name\" : {\r\n      get : function() {\r\n        return this.action.name;\r\n      }\r\n    },\r\n\r\n    \"icon\" : {\r\n      get : function() {\r\n        return this.action.icon;\r\n      }\r\n    },\r\n\r\n    \"title\" : {\r\n      get : function() {\r\n        return this.action.title;\r\n      }\r\n    },\r\n\r\n    \"text\" : {\r\n      get : function() {\r\n        return this.action.text;\r\n      }\r\n    },\r\n\r\n    \"htmlTag\" : {\r\n      get : function() {\r\n        return this.action.htmlTag;\r\n      }\r\n    },\r\n\r\n    \"disableTag\" : {\r\n      get : function() {\r\n        return this.action.disableTag;\r\n      }\r\n    },\r\n\r\n    \"menu\" : {\r\n      get : function() {\r\n        return this.action.menu;\r\n      }\r\n    },\r\n\r\n    \"editable\" : {\r\n      get : function() {\r\n        return this._options.editable;\r\n      }\r\n    },\r\n\r\n    \"active\" : {\r\n      get : function() {\r\n        return this.action.active;\r\n      }\r\n    },\r\n\r\n    \"disabled\" : {\r\n      get : function() {\r\n        return this.action.disabled;\r\n      }\r\n    },\r\n\r\n    \"needFocus\" : {\r\n      get : function() {\r\n        return this.action.needFocus;\r\n      }\r\n    },\r\n\r\n\r\n    \"shortcut\" : {\r\n      get : function() {\r\n        return this.action.shortcut;\r\n      }\r\n    },\r\n\r\n\r\n    init : function(opts) {\r\n      this.toolbar = opts.toolbar;\r\n      this.editor = opts.toolbar.editor;\r\n      this.action = opts.action;\r\n\r\n      //this.title = i18n.translate(this.name);\r\n      this._init();\r\n    }\r\n  }); \r\n\r\n  Button.prototype._tpl = {\r\n    item: '<li><a tabindex=\"-1\" unselectable=\"on\" class=\"toolbar-item\" href=\"javascript:;\"><span></span></a></li>',\r\n    menuWrapper: '<div class=\"toolbar-menu\"></div>',\r\n    menuItem: '<li><a tabindex=\"-1\" unselectable=\"on\" class=\"menu-item\" href=\"javascript:;\"><span></span></a></li>',\r\n    separator: '<li><span class=\"separator\"></span></li>'\r\n  };\r\n\r\n  Button.prototype._init = function() {\r\n    var k, len, ref, tag;\r\n    this.render();\r\n    this.el.on('mousedown', (function(_this) {\r\n      return function(e) {\r\n        var exceed, noFocus, param;\r\n        e.preventDefault();\r\n        noFocus = _this.needFocus && !_this.editor.editable.inputManager.focused;\r\n        if (_this.el.hasClass('disabled')) {\r\n          return false;\r\n        }\r\n        if (noFocus) {\r\n          _this.editor.focus();\r\n        }\r\n        if (_this.menu) {\r\n          _this.wrapper.toggleClass('menu-on').siblings('li').removeClass('menu-on');\r\n          if (_this.wrapper.is('.menu-on')) {\r\n            exceed = _this.menuWrapper.offset().left + _this.menuWrapper.outerWidth() + 5 - _this.editor.wrapper.offset().left - _this.editor.wrapper.outerWidth();\r\n            if (exceed > 0) {\r\n              _this.menuWrapper.css({\r\n                'left': 'auto',\r\n                'right': 0\r\n              });\r\n            }\r\n            _this.trigger('menuexpand');\r\n          }\r\n          return false;\r\n        }\r\n        param = _this.el.data('param');\r\n        _this.command(param);\r\n        return false;\r\n      };\r\n    })(this));\r\n    this.wrapper.on('click', 'a.menu-item', (function(_this) {\r\n      return function(e) {\r\n        var btn, noFocus, param;\r\n        e.preventDefault();\r\n        btn = $(e.currentTarget);\r\n        _this.wrapper.removeClass('menu-on');\r\n        noFocus = _this.needFocus && !_this.editor.editable.inputManager.focused;\r\n        if (btn.hasClass('disabled') || noFocus) {\r\n          return false;\r\n        }\r\n        _this.toolbar.wrapper.removeClass('menu-on');\r\n        param = btn.data('param');\r\n        _this.command(param);\r\n        return false;\r\n      };\r\n    })(this));\r\n    this.wrapper.on('mousedown', 'a.menu-item', function(e) {\r\n      return false;\r\n    });\r\n    this.editor.on('blur', (function(_this) {\r\n      return function() {\r\n        var editorActive;\r\n        editorActive = _this.editor.body.is(':visible') && _this.editor.body.is('[contenteditable]');\r\n        if (!(editorActive && !_this.editor.editable.clipboard.pasting)) {\r\n          return;\r\n        }\r\n        _this.setActive(false);\r\n        return _this.setDisabled(false);\r\n      };\r\n    })(this));\r\n    if (this.shortcut != null) {\r\n      this.editor.editable.hotkeys.add(this.shortcut, (function(_this) {\r\n        return function(e) {\r\n          _this.el.mousedown();\r\n          return false;\r\n        };\r\n      })(this));\r\n    }\r\n    ref = this.htmlTag.split(',');\r\n    for (k = 0, len = ref.length; k < len; k++) {\r\n      tag = ref[k];\r\n      tag = langx.trim(tag);\r\n      if (tag && langx.inArray(tag, this.editor.editable.formatter._allowedTags) < 0) {\r\n        this.editor.editable.formatter._allowedTags.push(tag);\r\n      }\r\n    }\r\n    return this.editor.on('selectionchanged', (function(_this) {\r\n      return function(e) {\r\n        if (_this.editor.editable.inputManager.focused) {\r\n          return _this._status();\r\n        }\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  Button.prototype.iconClassOf = function(icon) {\r\n    if (icon) {\r\n      return \"richeditor-icon richeditor-icon-\" + icon;\r\n    } else {\r\n      return '';\r\n    }\r\n  };\r\n\r\n  Button.prototype.setIcon = function(icon) {\r\n    return this.el.find('span').removeClass().addClass(this.iconClassOf(icon)).text(this.text);\r\n  };\r\n\r\n  Button.prototype.render = function() {\r\n    this.wrapper = $(this._tpl.item).appendTo(this.toolbar.list);\r\n    this.el = this.wrapper.find('a.toolbar-item');\r\n    this.el.attr('title', this.title).addClass(\"toolbar-item-\" + this.name).data('button', this);\r\n    this.setIcon(this.icon);\r\n    if (!this.menu) {\r\n      return;\r\n    }\r\n    this.menuWrapper = $(this._tpl.menuWrapper).appendTo(this.wrapper);\r\n    this.menuWrapper.addClass(\"toolbar-menu-\" + this.name);\r\n    return this.renderMenu();\r\n  };\r\n\r\n  Button.prototype.renderMenu = function() {\r\n    var $menuBtnEl, $menuItemEl, k, len, menuItem, ref, ref1, results;\r\n    if (!langx.isArray(this.menu)) {\r\n      return;\r\n    }\r\n    this.menuEl = $('<ul/>').appendTo(this.menuWrapper);\r\n    ref = this.menu;\r\n    results = [];\r\n    for (k = 0, len = ref.length; k < len; k++) {\r\n      menuItem = ref[k];\r\n      if (menuItem === '|') {\r\n        $(this._tpl.separator).appendTo(this.menuEl);\r\n        continue;\r\n      }\r\n      $menuItemEl = $(this._tpl.menuItem).appendTo(this.menuEl);\r\n      $menuBtnEl = $menuItemEl.find('a.menu-item').attr({\r\n        'title': (ref1 = menuItem.title) != null ? ref1 : menuItem.text,\r\n        'data-param': menuItem.param\r\n      }).addClass('menu-item-' + menuItem.name);\r\n      if (menuItem.icon) {\r\n        results.push($menuBtnEl.find('span').addClass(this.iconClassOf(menuItem.icon)));\r\n      } else {\r\n        results.push($menuBtnEl.find('span').text(menuItem.text));\r\n      }\r\n    }\r\n    return results;\r\n  };\r\n\r\n  Button.prototype.setActive = function(active) {\r\n    if (active === this.active) {\r\n      return;\r\n    }\r\n    this.active = active;\r\n    return this.el.toggleClass('active', this.active);\r\n  };\r\n\r\n  Button.prototype.setDisabled = function(disabled) {\r\n    if (disabled === this.disabled) {\r\n      return;\r\n    }\r\n    this.disabled = disabled;\r\n    return this.el.toggleClass('disabled', this.disabled);\r\n  };\r\n\r\n  Button.prototype._disableStatus = function() {\r\n    var disabled, endNodes, startNodes;\r\n    startNodes = this.editor.editable.selection.startNodes();\r\n    endNodes = this.editor.editable.selection.endNodes();\r\n    disabled = startNodes.filter(this.disableTag).length > 0 || endNodes.filter(this.disableTag).length > 0;\r\n    this.setDisabled(disabled);\r\n    if (this.disabled) {\r\n      this.setActive(false);\r\n    }\r\n    return this.disabled;\r\n  };\r\n\r\n  Button.prototype._activeStatus = function() {\r\n    var active, endNode, endNodes, startNode, startNodes;\r\n    startNodes = this.editor.editable.selection.startNodes();\r\n    endNodes = this.editor.editable.selection.endNodes();\r\n    startNode = startNodes.filter(this.htmlTag);\r\n    endNode = endNodes.filter(this.htmlTag);\r\n    active = startNode.length > 0 && endNode.length > 0 && startNode.is(endNode);\r\n    this.node = active ? startNode : null;\r\n    this.setActive(active);\r\n    return this.active;\r\n  };\r\n\r\n  Button.prototype._status = function() {\r\n    this._disableStatus();\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n    return this._activeStatus();\r\n  };\r\n\r\n  Button.prototype.command = function(param) {};\r\n\r\n  Button.prototype._t = i18n.translate;\r\n  \r\n\r\n  RichEditor.Button = Button;\r\n\r\n  return Button;\r\n});"]}