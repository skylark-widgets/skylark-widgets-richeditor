{"version":3,"sources":["RichEditor.js"],"names":["define","exports","module","__isValidToReturn","obj","Array","isArray","attr","__isEmptyObject","langx","$","Editable","Widget","Toolbar","uploader","i18n","RichEditor","inherit","options","srcNodeRef","placeholder","defaultImage","params","upload","template","_init","editor","uploadOpts","this","opts","textarea","length","Error","data","destroy","id","count","_render","self","editable","_elm","classPrefix","body","on","e","trigger","type","toolbar","toolbarFloat","toolbarHidden","toolbarFloatOffset","_placeholder","setValue","val","trim","focus","prototype","triggerHandler","args","concat","Evented","apply","key","ref","results","el","insertBefore","wrapper","find","placeholderEl","append","blur","push","name","value","insertAfter","children","util","isEmptyNode","parseInt","css","indentWidth","show","hide","hidePopover","getValue","each","i","popover","active","closest","off","selection","clear","inputManager","focused","removeData","remove","document","window","addons","general","actions"],"mappings":"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","file":"../RichEditor.js","sourcesContent":["define([], function () {\n    'use strict';\n    var exports = {};\n    var module = { exports: {} };\n    define([\n        'skylark-langx/langx',\n        'skylark-utils-dom/query',\n        'skylark-domx-contents/Editable',\n        'skylark-widgets-base/Widget',\n        './Toolbar',\n        './uploader',\n        './i18n'\n    ], function (langx, $, Editable, Widget, Toolbar, uploader, i18n) {\n        var RichEditor = Widget.inherit({\n            options: {\n                srcNodeRef: null,\n                placeholder: '',\n                defaultImage: 'images/image.png',\n                params: {},\n                upload: false,\n                template: '<div class=\"richeditor\">\\n  <div class=\"richeditor-wrapper\">\\n    <div class=\"richeditor-placeholder\"></div>\\n    <div class=\"richeditor-body\" contenteditable=\"true\">\\n    </div>\\n  </div>\\n</div>'\n            },\n            _init: function () {\n                this.opts = this.options;\n                var e, editor, uploadOpts;\n                this.textarea = $(this.opts.srcNodeRef);\n                this.opts.placeholder = this.opts.placeholder || this.textarea.attr('placeholder');\n                if (!this.textarea.length) {\n                    throw new Error('richeditor: param textarea is required.');\n                    return;\n                }\n                editor = this.textarea.data('richeditor');\n                if (editor != null) {\n                    editor.destroy();\n                }\n                this.id = ++RichEditor.count;\n                this._render();\n                var self = this;\n                this.editable = new Editable(this._elm, {\n                    classPrefix: 'richeditor-',\n                    textarea: this.textarea,\n                    body: this.body\n                });\n                this.editable.on('all', function (e, data) {\n                    return self.trigger(e.type, data);\n                });\n                if (this.opts.upload && uploader) {\n                    uploadOpts = typeof this.opts.upload === 'object' ? this.opts.upload : {};\n                    this.uploader = uploader(uploadOpts);\n                }\n                this.toolbar = new Toolbar(this, {\n                    toolbar: this.opts.toolbar,\n                    toolbarFloat: this.opts.toolbarFloat,\n                    toolbarHidden: this.opts.toolbarHidden,\n                    toolbarFloatOffset: this.opts.toolbarFloatOffset\n                });\n                if (this.opts.placeholder) {\n                    this.on('valuechanged', function () {\n                        return self._placeholder();\n                    });\n                }\n                this.setValue(this.textarea.val().trim() || '');\n                if (this.textarea.attr('autofocus')) {\n                    return self.focus();\n                }\n            }\n        });\n        RichEditor.prototype.triggerHandler = RichEditor.prototype.trigger = function (type, data) {\n            var args, ref;\n            args = [type];\n            if (data) {\n                args = args.concat(data);\n            }\n            langx.Evented.prototype.trigger.apply(this, args);\n            return this;\n        };\n        RichEditor.count = 0;\n        RichEditor.prototype._render = function () {\n            var key, ref, results, val;\n            this.el = $(this._elm).insertBefore(this.textarea);\n            this.wrapper = this.el.find('.richeditor-wrapper');\n            this.body = this.wrapper.find('.richeditor-body');\n            this.placeholderEl = this.wrapper.find('.richeditor-placeholder').append(this.opts.placeholder);\n            this.el.data('richeditor', this);\n            this.wrapper.append(this.textarea);\n            this.textarea.data('richeditor', this).blur();\n            this.body.attr('tabindex', this.textarea.attr('tabindex'));\n            if (this.opts.params) {\n                ref = this.opts.params;\n                results = [];\n                for (key in ref) {\n                    val = ref[key];\n                    results.push($('<input/>', {\n                        type: 'hidden',\n                        name: key,\n                        value: val\n                    }).insertAfter(this.textarea));\n                }\n                return results;\n            }\n        };\n        RichEditor.prototype._placeholder = function () {\n            var children;\n            children = this.body.children();\n            if (children.length === 0 || children.length === 1 && this.util.isEmptyNode(children) && parseInt(children.css('margin-left') || 0) < this.opts.indentWidth) {\n                return this.placeholderEl.show();\n            } else {\n                return this.placeholderEl.hide();\n            }\n        };\n        RichEditor.prototype.setValue = function (val) {\n            this.hidePopover();\n            this.editable.setValue(val);\n            return this.trigger('valuechanged');\n        };\n        RichEditor.prototype.getValue = function () {\n            return this.editable.getValue();\n        };\n        RichEditor.prototype.focus = function () {\n            return this.editable.focus();\n        };\n        RichEditor.prototype.blur = function () {\n            return this.editable.blur();\n        };\n        RichEditor.prototype.hidePopover = function () {\n            return this.el.find('.richeditor-popover').each(function (i, popover) {\n                popover = $(popover).data('popover');\n                if (popover.active) {\n                    return popover.hide();\n                }\n            });\n        };\n        RichEditor.prototype.destroy = function () {\n            this.triggerHandler('destroy');\n            this.textarea.closest('form').off('.richeditor .richeditor-' + this.id);\n            this.selection.clear();\n            this.inputManager.focused = false;\n            this.textarea.insertBefore(this.el).hide().val('').removeData('richeditor');\n            this.el.remove();\n            $(document).off('.richeditor-' + this.id);\n            $(window).off('.richeditor-' + this.id);\n            return this.off();\n        };\n        RichEditor.Toolbar = Toolbar;\n        RichEditor.i18n = i18n;\n        RichEditor.addons = {\n            general: {},\n            actions: {}\n        };\n        return RichEditor;\n    });\n    function __isEmptyObject(obj) {\n        var attr;\n        for (attr in obj)\n            return !1;\n        return !0;\n    }\n    function __isValidToReturn(obj) {\n        return typeof obj != 'object' || Array.isArray(obj) || !__isEmptyObject(obj);\n    }\n    if (__isValidToReturn(module.exports))\n        return module.exports;\n    else if (__isValidToReturn(exports))\n        return exports;\n});"]}