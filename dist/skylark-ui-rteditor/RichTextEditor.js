/**
 * skylark-ui-rteditor - The skylark rteditor widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-ui-rteditor/
 * @license MIT
 */
define(["skylark-langx/skylark","skylark-utils/langx","skylark-utils/browser","skylark-utils/datax","skylark-utils/eventer","skylark-utils/noder","skylark-utils/geom","skylark-utils/velm","skylark-utils/query","skylark-utils/widgets"],function(t,e,n,i,s,a,o,l,r,c){"use strict";var m=(t.ui=t.ui||{}).RichTextEditor=c.Widget.inherit({klassName:"RichTextEditor",pluginName:"rteditor",init:function(t,e){this.elem=t,e=e||{},this.className=e.className||"easyeditor",this.css=e.css||null,this.onLoaded="function"==typeof e.onLoaded?e.onLoaded:null,this.randomString="Cls"+Math.random().toString(36).substring(7),this.theme=e.theme||null;var n=this.doc=t.ownerDocument;this.win=n.defaultView||n.parentWindow,this.attachEvents()},attachEvents:function(){this.bootstrap(),this.handleKeypress(),this.handleResizeImage(),this.utils(),null!==this.onLoaded&&this.onLoaded.call(this)},detachEvents:function(){r(this.elem).removeClass(this.className).removeAttr("contenteditable").unwrap()},bootstrap:function(){r(this.elem).attr("contentEditable",!0).addClass(this.className).wrap('<div class="'+this.className+'-wrapper"></div>'),this.$wrapperElem=r(this.elem).parent(),null!==this.css&&r(this.elem).css(this.css),this.containerClass="."+this.className+"-wrapper","string"==typeof this.elem&&(this.elem=r(this.elem).get(0)),null!==this.theme&&r(this.elem).closest(this.containerClass).addClass(this.theme)},handleKeypress:function(){var t=this;r(t.elem).keydown(function(e){13===e.keyCode&&t.isSelectionInsideElement("li")}),t.elem.addEventListener("paste",function(e){e.preventDefault();var n=e.clipboardData.getData("text/plain").replace(/\n/gi,"<br>");t.doc.execCommand("insertHTML",!1,n)})},isSelectionInsideElement:function(t){var e,n,i=this.win,s=this.doc;for(t=t.toUpperCase(),i.getSelection?(e=i.getSelection()).rangeCount>0&&(n=e.getRangeAt(0).commonAncestorContainer):(e=s.selection)&&"Control"!=e.type&&(n=e.createRange().parentElement());n;){if(1==n.nodeType&&n.tagName==t)return!0;n=n.parentNode}return!1},handleResizeImage:function(){var t=this;r("html").delegate(t.containerClass+" figure","click",function(t){t.stopPropagation(),r(this).addClass("is-resizable")}),r("html").delegate(t.containerClass+" figure.is-resizable","mousemove",function(t){r(this).find("img").css({width:r(this).width()+"px"})}),r(t.doc).click(function(){r(t.elem).find("figure").removeClass("is-resizable")})},getSelection:function(){if(this.win.getSelection){var t=this.win.getSelection();if(t.rangeCount)return t}return!1},removeFormatting:function(t){var e=t.inFullArea;if(!0===this.isSelectionOutsideOfEditor())return!1;if(!1===e){var n=this.getSelection(),i=n.toString();if(n&&i.length>0){var s=n.getRangeAt(0),a=r(s.commonAncestorContainer.parentNode);if(a.attr("class")===this.className||a.attr("class")===this.className+"-wrapper"){var o=this.doc.createElement("span");r(o).attr("data-value","temp").html(i.replace(/\n/gi,"<br>")),s.deleteContents(),s.insertNode(o),r('[data-value="temp"]').contents().unwrap()}else{var l,c=!1;r.each(a.parentsUntil(this.elem),function(t,e){l=e,c=!0}),!0===c?r(l).html(r(l).text().replace(/\n/gi,"<br>")).contents().unwrap():a.contents().unwrap()}}}else r(this.elem).html(r(this.elem).text().replace(/\n/gi,"<br>"))},removeEmptyTags:function(){r(this.elem).html(r(this.elem).html().replace(/(<(?!\/)[^>]+>)+(<\/[^>]+>)+/,""))},removeBlockElementFromSelection:function(t,e){var n="";!0===(e=void 0!==e&&e)&&(n=", br");var i=t.getRangeAt(0).cloneContents(),s=this.doc.createElement("temp");return r(s).html(i),r(s).find("h1, h2, h3, h4, h5, h6, p, div"+n).each(function(){r(this).replaceWith(this.childNodes)}),r(s).html()},wrapSelectionWithNodeName:function(t){if(!0===this.isSelectionOutsideOfEditor())return!1;var e={name:"span",blockElement:!1,style:null,class:null,attribute:null,keepHtml:!1};"string"==typeof t?e.name=t:(e.name=t.nodeName||e.name,e.blockElement=t.blockElement||e.blockElement,e.style=t.style||e.style,e.class=t.class||e.class,e.attribute=t.attribute||e.attribute,e.keepHtml=t.keepHtml||e.keepHtml);var n=this.getSelection();if(n&&n.toString().length>0&&n.rangeCount){var i=this.isAlreadyWrapped(n,e),s=n.getRangeAt(0).cloneRange(),a=this.doc.createElement(e.name);if(null===e.style&&null===e.class&&null===e.attribute||(a=this.addAttribute(a,e)),this.selectionContainsHtml(s)){if(s=n.getRangeAt(0),!0===e.keepHtml){var o=s.cloneContents(),l=this.doc.createElement("div");l.appendChild(o),r(a).html(l.innerHTML)}else a.textContent=n.toString();s.deleteContents(),s.insertNode(a),s.commonAncestorContainer.localName===e.name&&(r(s.commonAncestorContainer).contents().unwrap(),this.removeEmptyTags())}else s.surroundContents(a),n.removeAllRanges(),n.addRange(s);!0===i&&this.removeWrappedDuplicateTag(a),this.removeEmptyTags(),n.select(),s.select()}},wrapSelectionWithList:function(t){if(t=t||"ul",!0===this.isSelectionOutsideOfEditor())return!1;var e=this.getSelection();if(e&&e.toString().length>0&&e.rangeCount){var n=this.removeBlockElementFromSelection(e,!0).split("\n").filter(function(t){return""!==t}),i=r.map(n,function(t){return"<li>"+r.trim(t)+"</li>"}),s=this.doc.createElement(t);r(s).html(i);var a=e.getRangeAt(0);a.deleteContents(),a.insertNode(s),e.removeAllRanges()}},selectionContainsHtml:function(t){return t.startContainer.parentNode.className!==this.className+"-wrapper"},isAlreadyWrapped:function(t,e){var n=t.getRangeAt(0),i=r(n.commonAncestorContainer),s=!1;return i.parent().prop("tagName").toLowerCase()===e.name&&!1===i.parent().hasClass(this.className)?s=!0:!0===e.blockElement?r.each(i.parentsUntil(this.elem),function(t,e){var n=e.tagName.toLowerCase();-1!==r.inArray(n,["h1","h2","h3","h4","h5","h6"])&&(s=!0)}):r.each(i.parentsUntil(this.elem),function(t,n){n.tagName.toLowerCase()===e.name&&(s=!0)}),s},removeWrappedDuplicateTag:function(t){var e=t.tagName;r(t).unwrap(),r(t).prop("tagName")===e&&!1===r(t).parent().hasClass(this.className)&&r(t).parent().hasClass(this.className+"-wrapper")&&r(t).unwrap()},addAttribute:function(t,e){return null!==e.style&&r(t).attr("style",e.style),null!==e.class&&r(t).addClass(e.class),null!==e.attribute&&(!0===r.isArray(e.attribute)?r(t).attr(e.attribute[0],e.attribute[1]):r(t).attr(e.attribute)),t},insertAtCaret:function(t){if(!0===this.isSelectionOutsideOfEditor())return!1;this.getSelection()?this.getSelection().getRangeAt(0).insertNode(t):r(t).appendTo(this.elem)},isSelectionOutsideOfEditor:function(){return!this.elementContainsSelection(this.elem)},isActive:function(){return this.elementContainsSelection(this.elem)},readonly:function(t){return void 0===t?r(this.elem).attr("contentEditable"):(r(this.elem).attr("contentEditable",t&&!0),this)},isOrContains:function(t,e){for(;t;){if(t===e)return!0;t=t.parentNode}return!1},elementContainsSelection:function(t){var e;if(this.win.getSelection){if((e=this.win.getSelection()).rangeCount>0){for(var n=0;n<e.rangeCount;++n)if(!this.isOrContains(e.getRangeAt(n).commonAncestorContainer,t))return!1;return!0}}else if((e=this.doc.selection)&&"Control"!==e.type)return this.isOrContains(e.createRange().parentElement(),t);return!1},insertHtml:function(t){r(this.elem).find("temp").html(t)},utils:function(){var t,e=this;(r("html").delegate("."+e.className+"-modal-close","click",function(t){t.preventDefault(),e.closeModal("#"+r(this).closest("."+e.className+"-modal").attr("id"))}),r("."+e.randomString+"-bind").length>0)&&r("html").delegate(e.elem,"click keyup",function(){var n=e.elem;clearTimeout(t),t=setTimeout(function(){r("."+e.randomString+"-bind").html(r(n).html())},250)});r(e.doc).click(function(t){r("."+e.className).closest("."+e.className+"-wrapper").find("."+e.className+"-toolbar > ul > li > ul").hide()})},getYoutubeVideoIdFromUrl:function(t){if(0===t.length)return!1;return void 0!==(t=t.replace(/(>|<)/gi,"").split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/))[2]?t[2].split(/[^0-9a-z_\-]/i)[0]:t},openModal:function(t){var e=this.doc.createElement("temp");e.textContent=".",this.insertAtCaret(e),r(t).removeClass("is-hidden")},closeModal:function(t){r(t).addClass("is-hidden").find("input").val(""),r(t).find("."+this.className+"-modal-content-body-loader").css("width","0");var e=r(this.elem).find("temp");"."===e.html()?e.remove():e.contents().unwrap(),r(this.elem).focus()},bold:function(){this.doc.execCommand("Bold")},italic:function(){this.doc.execCommand("Italic")},strike:function(){this.doc.execCommand("strikethrough")},listOl:function(){this.doc.execCommand("insertorderedlist")},listUl:function(){this.doc.execCommand("insertunorderedlist")},h2:function(){this.doc.execCommand("h2")},h3:function(){this.doc.execCommand("h3")},h4:function(){this.doc.execCommand("h4")},x:function(){this.doc.execCommand("h4")},alignleft:function(){this.doc.execCommand("justifyleft")},aligncenter:function(){this.doc.execCommand("justifycenter")},alignright:function(){this.doc.execCommand("justifyright")},alignfull:function(){this.doc.execCommand("justifyfull")},blockquote:function(){this.doc.execCommand("blockquote")},code:function(){this.doc.execCommand("p")},inserthorizontalrule:function(){this.doc.execCommand("inserthorizontalrule")},image:function(){var t=prompt("Insert Image URL","http://"),e=new RegExp("^((http|https)://|(mailto:)|(//))[a-z0-9]","i");null!==t&&""!==t&&"http://"!==t&&e.test(t)&&this.doc.execCommand("insertimage",!1,t)},link:function(){var t=prompt("Insert URL","http://"),e=new RegExp("^((http|https)://|(mailto:)|(//))[a-z0-9]","i");null!==t&&""!==t&&"http://"!==t&&e.test(t)&&this.doc.execCommand("createlink",!1,t)},indent:function(){this.doc.execCommand("indent")},outdent:function(){this.doc.execCommand("outdent")},toMd:function(){return toMarkdown(this.elem.innerHTML)}});return r.fn.rteditor=function(t){return this.each(function(){i.data(this,"richTextEditor")||i.data(this,"richTextEditor",new m(this,t))})},m});
//# sourceMappingURL=sourcemaps/RichTextEditor.js.map
