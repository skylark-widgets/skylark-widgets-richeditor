{"version":3,"sources":["addons/actions/VideoAction.js"],"names":["define","langx","$","addons","Action","VideoPopover","reUrlYoutube","reUrlVimeo","VideoAction","inherit","name","icon","htmlTag","disableTag","videoPlaceholder","videoContainerClass","videoPoster","needFocus","_init","_this","this","title","_t","merge","editor","editable","formatter","_allowedTags","extend","_allowedAttributes","embed","iframe","video","document","on","e","videoData","link","val","width","height","_insert","data","trigger","body","$video","currentTarget","find","popover","show","$videoWrap","html","remove","hide","$el","each","i","decorate","undecorate","action","prototype","call","parent","length","wrap","replaceWith","_execute","_create","_status","_disableStatus","range","inputManager","focused","focus","selection","deleteContents","attr","poster","class","insertNode","setRangeAfter","callback","match","iframeStart","iframeEnd","replace","$video1","style","data-link","data-width","data-height","_remove","actions"],"mappings":"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","file":"../../../addons/actions/VideoAction.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-query\",\r\n  \"../../addons\",\r\n  \"../../Action\",\r\n  \"./VideoPopover\"\r\n],function(langx,$,addons,Action,VideoPopover){ \r\n   var reUrlYoutube = /https?:\\/\\/(?:[0-9A-Z-]+\\.)?(?:youtu\\.be\\/|youtube\\.com\\S*[^\\w\\-\\s])([\\w\\-]{11})(?=[^\\w\\-]|$)(?![?=&+%\\w.-]*(?:['\"][^<>]*>|<\\/a>))[?=&+%\\w.-]*/ig,\r\n      reUrlVimeo = /https?:\\/\\/(www\\.)?vimeo.com\\/(\\d+)($|\\/)/;\r\n\r\n   var VideoAction = Action.inherit({\r\n      name : 'video',\r\n\r\n      icon : 'video',\r\n\r\n      htmlTag : 'embed, iframe',\r\n\r\n      disableTag : 'pre, table, div',\r\n\r\n      videoPlaceholder : 'video',\r\n\r\n      videoContainerClass : 'video-container',\r\n\r\n      videoPoster : './video_poster.jpg ',\r\n\r\n      needFocus : true,\r\n\r\n      _init : function() {\r\n        this.title = this._t(this.name);\r\n        langx.merge(this.editor.editable.formatter._allowedTags, ['embed', 'iframe', 'video']);\r\n        langx.extend(this.editor.editable.formatter._allowedAttributes, {\r\n          embed: ['class', 'width', 'height', 'type', 'pluginspage', 'src', 'wmode', 'play', 'loop', 'menu', 'allowscriptaccess', 'allowfullscreen'],\r\n          iframe: ['class', 'width', 'height', 'src', 'frameborder'],\r\n          video: ['class', 'width', 'height', 'poster', 'controls', 'allowfullscreen', 'src', 'data-link', 'data-tag']\r\n        });\r\n\r\n        $(document).on('click', '.J_UploadVideoBtn', (function(_this) {\r\n          return function(e) {\r\n            var videoData;\r\n            videoData = {\r\n              link: $('.video-link').val(),\r\n              width: $('#video-width').val() || 100,\r\n              height: $('#video-height').val() || 100\r\n            };\r\n            $('.video-link').val('');\r\n            $('#video-width').val('');\r\n            $('#video-height').val('');\r\n            return _this._insert($('.J_UploadVideoBtn').data('videowrap'), videoData, function() {\r\n              return _this.editor.trigger('valuechanged');\r\n            });\r\n          };\r\n        })(this));\r\n\r\n        this.editor.body.on('click', '.wordpad-video-wrapper', (function(_this) {\r\n          return function(e) {\r\n            var $video = $(e.currentTarget).find('video,embed,iframe');//siblings('video').show();\r\n            return _this.popover.show($video);\r\n          };\r\n        })(this));\r\n        this.editor.body.on('mousedown', (function(_this) {\r\n          return function() {\r\n            var $videoWrap;\r\n            $videoWrap = $('.J_UploadVideoBtn').data('videowrap');\r\n            if ($videoWrap && $videoWrap.html() === _this.videoPlaceholder) {\r\n              $videoWrap.remove();\r\n              $('.J_UploadVideoBtn').data('videowrap', null);\r\n            }\r\n            return _this.popover.hide();\r\n          };\r\n        })(this));\r\n        this.editor.on('decorate', (function(_this) {\r\n          return function(e, $el) {\r\n            return $el.find('video,iframe,embed').each(function(i, video) {\r\n              return _this.decorate($(video));\r\n            });\r\n          };\r\n        })(this));\r\n        this.editor.on('undecorate', (function(_this) {\r\n          return function(e, $el) {\r\n            return $el.find('video,iframe,embed').each(function(i, video) {\r\n              return _this.undecorate($(video));\r\n            });\r\n          };\r\n        })(this));\r\n\r\n        this.popover = new VideoPopover({\r\n          action: this\r\n        });\r\n        return Action.prototype._init.call(this);\r\n      },\r\n\r\n\r\n      decorate : function($video) {\r\n        if ($video.parent('.wordpad-video-wrapper').length > 0) {\r\n          return;\r\n        }\r\n        $video.wrap('<figure class=\"wordpad-video-wrapper\"></figure>');\r\n        return $video.parent();\r\n      },\r\n\r\n      undecorate : function($video) {\r\n        if (!($video.parent('.wordpad-video-wrapper').length > 0)) {\r\n          return;\r\n        }\r\n        return $video.parent().replaceWith($video);\r\n      },\r\n\r\n      _execute : function() {\r\n        var $video = this._create();\r\n        return this.popover.show($video);\r\n      },\r\n\r\n      _status : function() {\r\n        return this._disableStatus();\r\n      },\r\n\r\n      _create : function() {\r\n        var $video, range;\r\n        if (!this.editor.editable.inputManager.focused) {\r\n          this.editor.focus();\r\n        }\r\n        range = this.editor.editable.selection.range();\r\n        if (range) {\r\n          range.deleteContents();\r\n          this.editor.editable.selection.range(range);\r\n        }\r\n        $video = $('<video/>').attr({\r\n          'poster': this.videoPoster,\r\n          'width': 500,\r\n          'height': 281,\r\n          'class' : 'wordpad-video'\r\n        });\r\n        range.insertNode($video[0]);\r\n        this.editor.editable.selection.setRangeAfter($video, range);\r\n        this.editor.trigger('valuechanged');\r\n        this.decorate($video);\r\n        return $video;\r\n      },\r\n\r\n      _insert : function($video, videoData, callback) {\r\n        var e, originNode, realVideo, videoLink, videoTag;\r\n        if (!videoData.link) {\r\n          this._remove($video);\r\n        } else {\r\n          var data = videoData.link;\r\n          if (!data.match(/<iframe|<video|<embed/gi)) {\r\n            // parse if it is link on youtube & vimeo\r\n            var iframeStart = '<iframe style=\"width: 500px; height: 281px;\" src=\"',\r\n              iframeEnd = '\" frameborder=\"0\" allowfullscreen></iframe>';\r\n\r\n            if (data.match(reUrlYoutube))    {\r\n              data = data.replace(reUrlYoutube, iframeStart + 'https://www.youtube.com/embed/$1' + iframeEnd);\r\n            } else if (data.match(reUrlVimeo)) {\r\n              data = data.replace(reUrlVimeo, iframeStart + 'https://player.vimeo.com/video/$2' + iframeEnd);\r\n            }\r\n          }\r\n          var $video1 = $(data).style({\r\n            width : videoData.width + \"px\",\r\n            height : videoData.height + \"px\"\r\n          }).attr({\r\n            \"data-link\" : videoData.link,\r\n            \"data-width\" : videoData.width,\r\n            \"data-height\" : videoData.height\r\n          });\r\n          \r\n          $video.replaceWith($video1);\r\n          $video = $video1;\r\n        }\r\n        this.popover.hide();\r\n        return callback($video);\r\n      },\r\n\r\n      _remove : function($video) {\r\n        $video.parent().remove();\r\n      }\r\n\r\n   });\r\n\r\n\r\n   addons.actions.video = VideoAction; \r\n\r\n   return VideoAction;\r\n\r\n});"]}