{"version":3,"sources":["addons/actions/VideoAction.js"],"names":["define","langx","$","addons","Action","VideoPopover","VideoAction","inherit","name","icon","htmlTag","disableTag","videoPlaceholder","videoContainerClass","videoPoster","needFocus","_init","_this","this","title","_t","merge","editor","editable","formatter","_allowedTags","extend","_allowedAttributes","embed","iframe","video","document","on","e","videoData","link","val","width","height","loadVideo","data","trigger","body","$video","range","currentTarget","popover","show","createRange","selectNode","selection","util","support","onselectionchange","siblings","$videoWrap","html","remove","hide","$el","find","each","i","decorate","undecorate","action","prototype","call","videoSrc","tag","attr","parseVideo","parent","length","wrap","prepend","replaceWith","_execute","createVideo","_status","_disableStatus","callback","originNode","realVideo","videoLink","videoTag","get","tagName","toLowerCase","_error","data-link","data-tag","inputManager","focused","focus","deleteContents","poster","insertNode","setRangeAfter","src","actions"],"mappings":"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","file":"../../../addons/actions/VideoAction.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-query\",\r\n  \"../../addons\",\r\n  \"../../Action\",\r\n  \"./VideoPopover\"\r\n],function(langx,$,addons,Action,VideoPopover){ \r\n  \r\n   var VideoAction = Action.inherit({\r\n      name : 'video',\r\n\r\n      icon : 'video',\r\n\r\n      htmlTag : 'embed, iframe',\r\n\r\n      disableTag : 'pre, table, div',\r\n\r\n      videoPlaceholder : 'video',\r\n\r\n      videoContainerClass : 'video-container',\r\n\r\n      videoPoster : 'http://pic.yupoo.com/ccking/ESzA3WGs/svIoz.png',\r\n\r\n      needFocus : true,\r\n\r\n      _init : function() {\r\n        this.title = this._t(this.name);\r\n        langx.merge(this.editor.editable.formatter._allowedTags, ['embed', 'iframe', 'video']);\r\n        langx.extend(this.editor.editable.formatter._allowedAttributes, {\r\n          embed: ['class', 'width', 'height', 'type', 'pluginspage', 'src', 'wmode', 'play', 'loop', 'menu', 'allowscriptaccess', 'allowfullscreen'],\r\n          iframe: ['class', 'width', 'height', 'src', 'frameborder'],\r\n          video: ['class', 'width', 'height', 'poster', 'controls', 'allowfullscreen', 'src', 'data-link', 'data-tag']\r\n        });\r\n        $(document).on('click', '.J_UploadVideoBtn', (function(_this) {\r\n          return function(e) {\r\n            var videoData;\r\n            videoData = {\r\n              link: $('.video-link').val(),\r\n              width: $('#video-width').val() || 100,\r\n              height: $('#video-height').val() || 100\r\n            };\r\n            $('.video-link').val('');\r\n            $('#video-width').val('');\r\n            $('#video-height').val('');\r\n            return _this.loadVideo($('.J_UploadVideoBtn').data('videowrap'), videoData, function() {\r\n              return _this.editor.trigger('valuechanged');\r\n            });\r\n          };\r\n        })(this));\r\n        this.editor.body.on('click', 'video', (function(_this) {\r\n          return function(e) {\r\n            var $video, range;\r\n            $video = $(e.currentTarget);\r\n            _this.popover.show($video);\r\n            range = document.createRange();\r\n            range.selectNode($video[0]);\r\n            _this.editor.editable.selection.range(range);\r\n            if (!_this.editor.editable.util.support.onselectionchange) {\r\n              _this.editor.trigger('selectionchanged');\r\n            }\r\n            return false;\r\n          };\r\n        })(this));\r\n        this.editor.body.on('mouseenter', '.wordpad-video .real-video', (function(_this) {\r\n          return function(e) {\r\n            var $video = $(e.currentTarget).siblings('video').show();\r\n            return _this.popover.show($video);\r\n          };\r\n        })(this));\r\n        this.editor.body.on('mousedown', (function(_this) {\r\n          return function() {\r\n            var $videoWrap;\r\n            $videoWrap = $('.J_UploadVideoBtn').data('videowrap');\r\n            if ($videoWrap && $videoWrap.html() === _this.videoPlaceholder) {\r\n              $videoWrap.remove();\r\n              $('.J_UploadVideoBtn').data('videowrap', null);\r\n            }\r\n            return _this.popover.hide();\r\n          };\r\n        })(this));\r\n        this.editor.on('decorate', (function(_this) {\r\n          return function(e, $el) {\r\n            return $el.find('video').each(function(i, video) {\r\n              return _this.decorate($(video));\r\n            });\r\n          };\r\n        })(this));\r\n        this.editor.on('undecorate', (function(_this) {\r\n          return function(e, $el) {\r\n            return $el.find('video').each(function(i, video) {\r\n              return _this.undecorate($(video));\r\n            });\r\n          };\r\n        })(this));\r\n\r\n        this.popover = new VideoPopover({\r\n          action: this\r\n        });\r\n        return Action.prototype._init.call(this);\r\n      },\r\n\r\n\r\n      decorate : function($video) {\r\n        var videoData, videoSrc;\r\n        videoData = {\r\n          tag: $video.attr('data-tag'),\r\n          link: $video.attr('data-link'),\r\n          width: $video.attr('width'),\r\n          height: $video.attr('height')\r\n        };\r\n        videoSrc = this.parseVideo(videoData);\r\n        if ($video.parent('.wordpad-video').length > 0) {\r\n          this.undecorate($video);\r\n        }\r\n        $video.wrap('<p class=\"wordpad-video\"></p>');\r\n        $video.parent().prepend(videoSrc);\r\n        $video.hide();\r\n        return $video.parent();\r\n      },\r\n\r\n      undecorate : function($video) {\r\n        if (!($video.parent('.wordpad-video').length > 0)) {\r\n          return;\r\n        }\r\n        $video.siblings('.real-video').remove();\r\n        return $video.parent().replaceWith($video);\r\n      },\r\n\r\n      _execute : function() {\r\n        var $video, _self;\r\n        _self = this;\r\n        $video = this.createVideo();\r\n        return this.popover.show($video);\r\n      },\r\n\r\n      _status : function() {\r\n        return this._disableStatus();\r\n      },\r\n\r\n      loadVideo : function($video, videoData, callback) {\r\n        var e, originNode, realVideo, videoLink, videoTag;\r\n        if (!videoData.link && !$video.attr('data-link')) {\r\n          $video.remove();\r\n        } else {\r\n          if (!videoData.link) {\r\n            videoData.link = $video.attr('data-link');\r\n          }\r\n          try {\r\n            originNode = $(videoData.link);\r\n            videoTag = originNode.get(0).tagName.toLowerCase();\r\n            videoLink = originNode.attr('src');\r\n          } catch (_error) {\r\n            e = _error;\r\n            videoLink = videoData.link;\r\n            videoTag = '';\r\n          }\r\n          videoData.tag = videoTag;\r\n          $video.attr({\r\n            'data-link': videoLink,\r\n            'data-tag': videoTag,\r\n            'width': videoData.width || 100,\r\n            'height': videoData.height || 100\r\n          });\r\n          realVideo = $video.siblings('.real-video');\r\n          if (realVideo.length) {\r\n            videoData.link = videoLink;\r\n            realVideo.replaceWith(this.parseVideo(videoData));\r\n          } else {\r\n            this.decorate($video);\r\n          }\r\n        }\r\n        this.popover.hide();\r\n        return callback($video);\r\n      },\r\n\r\n      createVideo : function() {\r\n        var $videoWrap, range;\r\n        if (!this.editor.editable.inputManager.focused) {\r\n          this.editor.focus();\r\n        }\r\n        range = this.editor.editable.selection.range();\r\n        if (range) {\r\n          range.deleteContents();\r\n          this.editor.editable.selection.range(range);\r\n        }\r\n        $videoWrap = $('<video/>').attr({\r\n          'poster': this.videoPoster,\r\n          'width': 100,\r\n          'height': 100\r\n        });\r\n        range.insertNode($videoWrap[0]);\r\n        this.editor.editable.selection.setRangeAfter($videoWrap, range);\r\n        this.editor.trigger('valuechanged');\r\n        return $videoWrap;\r\n      },\r\n\r\n      parseVideo : function(videoData) {\r\n        var src;\r\n        switch (videoData.tag) {\r\n          case 'embed':\r\n            src = '<embed class=\"real-video\" width=' + videoData.width + ' height= ' + videoData.height + ' src=\"' + videoData.link + ' \"type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" wmode=\"transparent\" loop=\"false\" menu=\"false\" allowscriptaccess=\"never\" allowfullscreen=\"true\">';\r\n            break;\r\n          case 'iframe':\r\n            src = '<iframe class=\"real-video\" width=' + videoData.width + ' height= ' + videoData.height + ' src=\" ' + videoData.link + '\" frameborder=0 allowfullscreen></iframe>';\r\n            break;\r\n          default:\r\n            src = videoData.link;\r\n        }\r\n        return src;\r\n\r\n      }\r\n\r\n   });\r\n\r\n\r\n   addons.actions.video = VideoAction; \r\n\r\n   return VideoAction;\r\n\r\n});"]}