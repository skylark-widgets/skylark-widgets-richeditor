{"version":3,"sources":["uploader.js"],"names":["define","langx","$","Xhr","id","Uploader","Evented","inherit","init","options","_this","this","mixin","files","queue","count","on","e","file","splice","inArray","length","connectionCount","upload","shift","uploading","window","originalEvent","returnValue","_t","prototype","url","params","fileKey","generateId","f","i","key","len","isArray","FileList","is","attr","makeArray","obj","getFile","extend","push","trigger","_xhrUpload","fileObj","name","ref","ref1","File","Blob","fileName","size","fileSize","ext","split","pop","toLowerCase","formData","k","v","FormData","append","xhr","post","data","processData","contentType","headers","X-File-Name","encodeURIComponent","progress","lengthComputable","loaded","total","then","result","catch","status","cancel","abort","destroy","off","document","i18n","zh-CN","leaveConfirm","locale"],"mappings":";;;;;;;AAAAA,QACE,sBACA,qBACA,wBACA,SAASC,EAAMC,EAAEC,GAEjB,IA0CMC,EA1CFC,EAAWJ,EAAMK,QAAQC,SAC3BC,KAAO,SAASC,GAMY,IAAUC,EALpCC,KAAKF,QAAUR,EAAMW,SAASD,KAAKF,QAAQA,GAE3CE,KAAKE,SACLF,KAAKG,SACLH,KAAKP,KAAOC,EAASU,MACrBJ,KAAKK,GAAG,kBAA4BN,EASjCC,KARM,SAASM,EAAGC,GAEjB,OADAR,EAAMG,MAAMM,OAAOlB,EAAMmB,QAAQF,EAAMR,EAAMG,OAAQ,GACjDH,EAAMI,MAAMO,OAAS,GAAKX,EAAMG,MAAMQ,OAASX,EAAMD,QAAQa,gBACxDZ,EAAMa,OAAOb,EAAMI,MAAMU,SAEzBd,EAAMe,WAAY,KAI/BvB,EAAEwB,QAAQV,GAAG,yBAA2BL,KAAKP,GAAI,SAAUM,GACzD,OAAO,SAASO,GACd,GAAKP,EAAMe,UAIX,OADAR,EAAEU,cAAcC,YAAclB,EAAMmB,GAAG,gBAChCnB,EAAMmB,GAAG,iBAN6B,CAQ9ClB,UAuKP,OAlKAN,EAASU,MAAQ,EAEjBV,EAASyB,UAAUrB,SACjBsB,IAAK,GACLC,OAAQ,KACRC,QAAS,cACTX,gBAAiB,GAKnBjB,EAASyB,UAAUI,YAEjB9B,EAAK,EACE,WACL,OAAOA,GAAM,IAIjBC,EAASyB,UAAUP,OAAS,SAASL,EAAMT,GACzC,IAAI0B,EAAGC,EAAGC,EAAKC,EAIf,GAHe,MAAX7B,IACFA,MAEU,MAARS,EAAJ,CAGA,GAAIjB,EAAMsC,QAAQrB,IAASA,aAAgBsB,SACzC,IAAKJ,EAAI,EAAGE,EAAMpB,EAAKG,OAAQe,EAAIE,EAAKF,IACtCD,EAAIjB,EAAKkB,GACTzB,KAAKY,OAAOY,EAAG1B,QAERP,EAAEgB,GAAMuB,GAAG,gBACpBJ,EAAMnC,EAAEgB,GAAMwB,KAAK,WAEjBjC,EAAQwB,QAAUI,GAEpB1B,KAAKY,OAAOtB,EAAM0C,UAAUzC,EAAEgB,GAAM,GAAGL,OAAQJ,IACrCS,EAAKd,IAAOc,EAAK0B,MAC3B1B,EAAOP,KAAKkC,QAAQ3B,IAEtB,GAAMA,GAAQA,EAAK0B,IAInB,GADA3C,EAAM6C,OAAO5B,EAAMT,GACfE,KAAKE,MAAMQ,QAAUV,KAAKF,QAAQa,gBACpCX,KAAKG,MAAMiC,KAAK7B,QAGlB,IAA2C,IAAvCP,KAAKqC,QAAQ,eAAgB9B,GAKjC,OAFAP,KAAKE,MAAMkC,KAAK7B,GAChBP,KAAKsC,WAAW/B,GACTP,KAAKc,WAAY,IAG1BpB,EAASyB,UAAUe,QAAU,SAASK,GACpC,IAAIC,EAAMC,EAAKC,EACf,OAAIH,aAAmBxB,OAAO4B,MAAQJ,aAAmBxB,OAAO6B,MAC9DJ,EAAmC,OAA3BC,EAAMF,EAAQM,UAAoBJ,EAAMF,EAAQC,MAKxD/C,GAAIO,KAAKuB,aACTH,IAAKpB,KAAKF,QAAQsB,IAClBC,OAAQrB,KAAKF,QAAQuB,OACrBC,QAAStB,KAAKF,QAAQwB,QACtBkB,KAAMA,EACNM,KAAmC,OAA5BJ,EAAOH,EAAQQ,UAAoBL,EAAOH,EAAQO,KACzDE,IAAKR,EAAOA,EAAKS,MAAM,KAAKC,MAAMC,cAAgB,GAClDlB,IAAKM,IAVE,MAcX7C,EAASyB,UAAUmB,WAAa,SAAS/B,GACvC,IAAI6C,EAAUC,EAAGZ,EAAKa,EAItB,IAHAF,EAAW,IAAIG,UACNC,OAAOjD,EAAKe,QAASf,EAAK0B,KACnCmB,EAASI,OAAO,oBAAqBjD,EAAKiC,MACtCjC,EAAKc,OAEP,IAAKgC,KADLZ,EAAMlC,EAAKc,OAETiC,EAAIb,EAAIY,GACRD,EAASI,OAAOH,EAAGC,GAKvB,IAAIG,EAAOlD,EAAKkD,IAAM,IAAIjE,GACxB4B,IAAKpB,KAAKF,QAAQsB,MAIhBrB,EAAQC,KAwBZ,OAtBAyD,EAAIC,MACFC,KAAMP,EACNQ,aAAa,EACbC,aAAa,EACbC,SACEC,cAAeC,mBAAmBzD,EAAKiC,SAExCyB,SAAS,SAAS3D,GACnB,GAAKA,EAAE4D,iBAGP,OAAOnE,EAAMsC,QAAQ,iBAAkB9B,EAAMD,EAAE6D,OAAQ7D,EAAE8D,SACxDC,KAAK,SAASC,GACfvE,EAAMsC,QAAQ,gBAAiB9B,EAAM+D,GAErCvE,EAAMsC,QAAQ,oBAEbkC,MAAM,SAASjE,EAAEkE,GAClBzE,EAAMsC,QAAQ,cAAe9B,EAAKkD,GAClC1D,EAAMsC,QAAQ,oBAGToB,GAGT/D,EAASyB,UAAUsD,OAAS,SAASlE,GACnC,IAAIiB,EAAGC,EAAGE,EAAKc,EACf,IAAKlC,EAAKd,GAER,IAAKgC,EAAI,EAAGE,GADZc,EAAMzC,KAAKE,OACWQ,OAAQe,EAAIE,EAAKF,IAErC,IADAD,EAAIiB,EAAIhB,IACFhC,KAAc,EAAPc,EAAU,CACrBA,EAAOiB,EACP,MAQN,OAJAxB,KAAKqC,QAAQ,gBAAiB9B,IAC1BA,EAAKkD,KACPlD,EAAKkD,IAAIiB,QAEJnE,EAAKkD,IAAM,MAIpB/D,EAASyB,UAAUwD,QAAU,WAC3B,IAAIpE,EAAMkB,EAAGE,EAAKc,EAGlB,IAFAzC,KAAKG,MAAMO,OAAS,EAEfe,EAAI,EAAGE,GADZc,EAAMzC,KAAKE,OACWQ,OAAQe,EAAIE,EAAKF,IACrClB,EAAOkC,EAAIhB,GACXzB,KAAKyE,OAAOlE,GAGd,OADAhB,EAAEwB,QAAQ6D,IAAI,aAAe5E,KAAKP,IAC3BF,EAAEsF,UAAUD,IAAI,aAAe5E,KAAKP,KAG7CC,EAASoF,MACPC,SACEC,aAAc,uBAIlBtF,EAASuF,OAAS,QAEV,SAASnF,GACf,OAAO,IAAIJ,EAASI","file":"../uploader.js","sourcesContent":["define([\n  \"skylark-langx/langx\",\n  \"skylark-domx-query\",\n  \"skylark-net-http/Xhr\"\n],function(langx,$,Xhr){ \n\n  var Uploader = langx.Evented.inherit({\n    init : function(options){\n      this.options = langx.mixin({},this.options,options);\n\n      this.files = [];\n      this.queue = [];\n      this.id = ++Uploader.count;\n      this.on('uploadcomplete', (function(_this) {\n        return function(e, file) {\n          _this.files.splice(langx.inArray(file, _this.files), 1);\n          if (_this.queue.length > 0 && _this.files.length < _this.options.connectionCount) {\n            return _this.upload(_this.queue.shift());\n          } else {\n            return _this.uploading = false;\n          }\n        };\n      })(this));\n      $(window).on('beforeunload.uploader-' + this.id, (function(_this) {\n        return function(e) {\n          if (!_this.uploading) {\n            return;\n          }\n          e.originalEvent.returnValue = _this._t('leaveConfirm');\n          return _this._t('leaveConfirm');  \n        };\n      })(this));\n    }\n\n  });\n\n  Uploader.count = 0;\n\n  Uploader.prototype.options = {\n    url: '',\n    params: null,\n    fileKey: 'upload_file',\n    connectionCount: 3\n  };\n\n\n\n  Uploader.prototype.generateId = (function() {\n    var id;\n    id = 0;\n    return function() {\n      return id += 1;\n    };\n  })();\n\n  Uploader.prototype.upload = function(file, options) {\n    var f, i, key, len;\n    if (options == null) {\n      options = {};\n    }\n    if (file == null) {\n      return;\n    }\n    if (langx.isArray(file) || file instanceof FileList) {\n      for (i = 0, len = file.length; i < len; i++) {\n        f = file[i];\n        this.upload(f, options);\n      }\n    } else if ($(file).is('input:file')) {\n      key = $(file).attr('name');\n      if (key) {\n        options.fileKey = key;\n      }\n      this.upload(langx.makeArray($(file)[0].files), options);\n    } else if (!file.id || !file.obj) {\n      file = this.getFile(file);\n    }\n    if (!(file && file.obj)) {\n      return;\n    }\n    langx.extend(file, options);\n    if (this.files.length >= this.options.connectionCount) {\n      this.queue.push(file);\n      return;\n    }\n    if (this.trigger('beforeupload', file) === false) {\n      return;\n    }\n    this.files.push(file);\n    this._xhrUpload(file);\n    return this.uploading = true;\n  };\n\n  Uploader.prototype.getFile = function(fileObj) {\n    var name, ref, ref1;\n    if (fileObj instanceof window.File || fileObj instanceof window.Blob) {\n      name = (ref = fileObj.fileName) != null ? ref : fileObj.name;\n    } else {\n      return null;\n    }\n    return {\n      id: this.generateId(),\n      url: this.options.url,\n      params: this.options.params,\n      fileKey: this.options.fileKey,\n      name: name,\n      size: (ref1 = fileObj.fileSize) != null ? ref1 : fileObj.size,\n      ext: name ? name.split('.').pop().toLowerCase() : '',\n      obj: fileObj\n    };\n  };\n\n  Uploader.prototype._xhrUpload = function(file) {\n    var formData, k, ref, v;\n    formData = new FormData();\n    formData.append(file.fileKey, file.obj);\n    formData.append(\"original_filename\", file.name);\n    if (file.params) {\n      ref = file.params;\n      for (k in ref) {\n        v = ref[k];\n        formData.append(k, v);\n      }\n    }\n\n    //TODO\n    var xhr =  file.xhr = new Xhr({\n      url: this.options.url\n    });\n\n\n    var _this = this;\n\n    xhr.post({\n      data: formData,\n      processData: false,\n      contentType: false,\n      headers: {\n        'X-File-Name': encodeURIComponent(file.name)\n      },\n    }).progress(function(e){\n      if (!e.lengthComputable) {\n        return;\n      }\n      return _this.trigger('uploadprogress', file, e.loaded, e.total);\n    }).then(function(result){\n      _this.trigger('uploadsuccess', file, result);\n\n      _this.trigger('uploadcomplete');\n\n    }).catch(function(e,status){\n      _this.trigger('uploaderror', file,xhr);\n      _this.trigger('uploadcomplete');\n    });\n\n    return xhr;\n  };\n\n  Uploader.prototype.cancel = function(file) {\n    var f, i, len, ref;\n    if (!file.id) {\n      ref = this.files;\n      for (i = 0, len = ref.length; i < len; i++) {\n        f = ref[i];\n        if (f.id === file * 1) {\n          file = f;\n          break;\n        }\n      }\n    }\n    this.trigger('uploadcancel', [file]);\n    if (file.xhr) {\n      file.xhr.abort();\n    }\n    return file.xhr = null;\n  };\n\n\n  Uploader.prototype.destroy = function() {\n    var file, i, len, ref;\n    this.queue.length = 0;\n    ref = this.files;\n    for (i = 0, len = ref.length; i < len; i++) {\n      file = ref[i];\n      this.cancel(file);\n    }\n    $(window).off('.uploader-' + this.id);\n    return $(document).off('.uploader-' + this.id);\n  };\n\n  Uploader.i18n = {\n    'zh-CN': {\n      leaveConfirm: '正在上传文件，如果离开上传会自动取消'\n    }\n  };\n\n  Uploader.locale = 'zh-CN';\n\n  return  function(options) {\n    return new Uploader(options);\n  };\n\n});\n"]}