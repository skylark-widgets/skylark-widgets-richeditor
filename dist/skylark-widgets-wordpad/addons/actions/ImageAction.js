/**
 * skylark-widgets-wordpad - The skylark richeditor widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-wordpad/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-domx-query","skylark-storages-diskfs/select","skylark-storages-diskfs/readImage","../../addons","../../Action","./ImagePopover","../../i18n"],function(e,t,a,i,o,r,n,s){var d=r.inherit({name:"image",icon:"image",htmlTag:"img",disableTag:"pre, table",placeholderImage:"",needFocus:!1,_init:function(){var e,a,i,o,d;if(r.prototype._init.call(this),this.editor.options.imageAction)if(Array.isArray(this.editor.options.imageAction))for(this.menu=[],a=0,i=(o=this.editor.options.imageAction).length;a<i;a++)e=o[a],this.menu.push({name:e+"-image",text:this._t(e+"Image")});else this.menu=!1;else null!=this.editor.uploader?this.menu=[{name:"upload-image",text:s.translate("uploadImage"),param:"uploadImage"},{name:"external-image",text:s.translate("externalImage"),param:"externalImage"}]:this.menu=!1;if(this.placeholderImage=this.editor.options.addons.actions.image.placeholderImage,this.editor.body.on("click","img:not([data-non-image])",(d=this,function(e){var a,i;return a=t(e.currentTarget),(i=document.createRange()).selectNode(a[0]),d.editor.editable.selection.range(i),d.editor.editable.util.support.onselectionchange||d.editor.trigger("selectionchanged"),!1})),this.editor.body.on("mouseup","img:not([data-non-image])",function(e){return!1}),this.editor.on("selectionchanged.image",function(e){return function(){var a,i,o;if(null!=(o=e.editor.editable.selection.range()))return 1===(a=t(o.cloneContents()).contents()).length&&a.is("img:not([data-non-image])")?(i=t(o.startContainer).contents().eq(o.startOffset),e.popover||(e.popover=new n({action:e})),e.popover.show(i)):e.popover?e.popover.hide():void 0}}(this)),this.editor.on("valuechanged.image",function(e){return function(){var a;if((a=e.editor.wrapper.find(".wordpad-image-loading")).length>0)return a.each(function(a,i){var o,r,n;if(!((o=(r=t(i)).data("img"))&&o.parent().length>0)&&(r.remove(),o&&(n=o.data("file"))&&(e.editor.uploader.cancel(n),e.editor.body.find("img.uploading").length<1)))return e.editor.uploader.trigger("uploadready",[n])})}}(this)),this.popover=new n({action:this}),this.editor.options.upload)return this._initUploader()},_initUploader:function(a){var o;return this.editor.uploader.on("beforeupload",(o=this,function(e,a){var r;if(a.inline)return a.img?r=t(a.img):(r=o.createImage(a.name),a.img=r),r.addClass("uploading"),r.data("file",a),i(a.obj).then(function(e){var t;if(r.hasClass("uploading"))return t=e?e.src:o.placeholderImage,o.loadImage(r,t,function(){if(o.popover.active)return o.popover.refresh(),o.popover.srcEl.val(o._t("uploading")).prop("disabled",!0)})})})),uploadProgress=e.proxy(this.editor.editable.util.throttle(function(e,t,a,i){var o,r,n;if(t.inline&&(r=t.img.data("mask"))){if((o=r.data("img")).hasClass("uploading")&&o.parent().length>0)return(n=(100*(n=a/i)).toFixed(0))>99&&(n=99),r.find(".progress").height(100-n+"%");r.remove()}},500),this),this.editor.uploader.on("uploadprogress",uploadProgress),this.editor.uploader.on("uploadsuccess",function(e){return function(t,a,i){var o,r;if(a.inline&&(o=a.img).hasClass("uploading")&&o.parent().length>0){try{"object"!=typeof i&&(i=JSON.parse(i)),r=e.editor.options.upload.uploadedImagePath?e.editor.options.upload.uploadedImagePath(i):i.files[0].url}catch(e){e,i={success:!1}}return e.loadImage(o,r,function(){var t;if(o.removeData("file"),o.removeClass("uploading").removeClass("loading"),(t=o.data("mask"))&&t.remove(),o.removeData("mask"),e.editor.trigger("valuechanged"),e.editor.body.find("img.uploading").length<1)return e.editor.uploader.trigger("uploadready",[a,i])}),e.popover.active?(e.popover.srcEl.prop("disabled",!1),e.popover.srcEl.val(r)):void 0}}}(this)),this.editor.uploader.on("uploaderror",function(e){return function(t,a,i){var o,r;if(a.inline&&"abort"!==i.statusText){if(i.responseText)try{(r=JSON.parse(i.responseText)).msg}catch(t){t,e._t("uploadError")}if((o=a.img).hasClass("uploading")&&o.parent().length>0)return e.loadImage(o,e.placeholderImage,function(){var e;return o.removeData("file"),o.removeClass("uploading").removeClass("loading"),(e=o.data("mask"))&&e.remove(),o.removeData("mask")}),e.popover.active&&(e.popover.srcEl.prop("disabled",!1),e.popover.srcEl.val(e.placeholderImage)),e.editor.trigger("valuechanged"),e.editor.body.find("img.uploading").length<1?e.editor.uploader.trigger("uploadready",[a,r]):void 0}}}(this))},_status:function(){return this._disableStatus()},loadImage:function(a,i,o){var r,n,s,d;return d=this,s=function(){var e,t;return e=a.offset(),t=d.editor.wrapper.offset(),r.css({top:e.top-t.top,left:e.left-t.left,width:a.width(),height:a.height()}).show()},a.addClass("loading"),(r=a.data("mask"))||(r=t('<div class="wordpad-image-loading">\n  <div class="progress"></div>\n</div>').hide().appendTo(this.editor.wrapper),s(),a.data("mask",r),r.data("img",a)),(n=new Image).onload=function(t){return function(){var d,l;if(a.hasClass("loading")||a.hasClass("uploading"))return l=n.width,d=n.height,a.attr({src:i,width:l,height:d,"data-image-size":l+","+d}).removeClass("loading"),a.hasClass("uploading")?(t.editor.editable.util.reflow(t.editor.body),s()):(r.remove(),a.removeData("mask")),t.editor.trigger("valuechanged"),e.isFunction(o)?o(n):void 0}}(this),n.onerror=function(){return e.isFunction(o)&&o(!1),r.remove(),a.removeData("mask").removeClass("loading")},n.src=i},createImage:function(e){var a,i;return null==e&&(e="Image"),this.editor.editable.inputManager.focused||this.editor.focus(),(i=this.editor.editable.selection.range()).deleteContents(),this.editor.editable.selection.range(i),a=t("<img/>").attr("alt",e),i.insertNode(a[0]),this.editor.editable.selection.setRangeAfter(a,i),this.editor.trigger("valuechanged"),a},_execute:function(e){var t,i=this;if("uploadImage"!=e){var o=this.createImage();return this.loadImage(o,this.placeholderImage,(t=this,function(){return t.editor.trigger("valuechanged"),t.editor.editable.util.reflow(o),o.click(),t.popover.one("popovershow",function(){return t.popover.srcEl.focus(),t.popover.srcEl[0].select()})}))}a({title:this._t("uploadImage"),multiple:!0,accept:"image/gif,image/jpeg,image/jpg,image/png,image/svg",picked:function(e){i.editor.uploader.upload(e,{inline:!0})}})}});return o.actions.image=d,d});
//# sourceMappingURL=../../sourcemaps/addons/actions/ImageAction.js.map
