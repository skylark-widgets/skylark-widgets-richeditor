/**
 * skylark-widgets-wordpad - The skylark richeditor widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-wordpad/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-domx-query","skylark-net-http/Xhr"],function(e,t,n){var i,o=e.Evented.inherit({init:function(n){var i;this.options=e.mixin({},this.options,n),this.files=[],this.queue=[],this.id=++o.count,this.on("uploadcomplete",(i=this,function(t,n){return i.files.splice(e.inArray(n,i.files),1),i.queue.length>0&&i.files.length<i.options.connectionCount?i.upload(i.queue.shift()):i.uploading=!1})),t(window).on("beforeunload.uploader-"+this.id,function(e){return function(t){if(e.uploading)return t.originalEvent.returnValue=e._t("leaveConfirm"),e._t("leaveConfirm")}}(this))}});return o.count=0,o.prototype.options={url:"",params:null,fileKey:"upload_file",connectionCount:3},o.prototype.generateId=(i=0,function(){return i+=1}),o.prototype.upload=function(n,i){var o,r,s,l;if(null==i&&(i={}),null!=n){if(e.isArray(n)||n instanceof FileList)for(r=0,l=n.length;r<l;r++)o=n[r],this.upload(o,i);else t(n).is("input:file")?((s=t(n).attr("name"))&&(i.fileKey=s),this.upload(e.makeArray(t(n)[0].files),i)):n.id&&n.obj||(n=this.getFile(n));if(n&&n.obj)if(e.extend(n,i),this.files.length>=this.options.connectionCount)this.queue.push(n);else if(!1!==this.trigger("beforeupload",[n]))return this.files.push(n),this._xhrUpload(n),this.uploading=!0}},o.prototype.getFile=function(e){var t,n,i;return e instanceof window.File||e instanceof window.Blob?(t=null!=(n=e.fileName)?n:e.name,{id:this.generateId(),url:this.options.url,params:this.options.params,fileKey:this.options.fileKey,name:t,size:null!=(i=e.fileSize)?i:e.size,ext:t?t.split(".").pop().toLowerCase():"",obj:e}):null},o.prototype._xhrUpload=function(e){var i,o,r,s;if((i=new FormData).append(e.fileKey,e.obj),i.append("original_filename",e.name),e.params)for(o in r=e.params)s=r[o],i.append(o,s);var l,u=e.xhr=new n({url:this.options.url});return u.post({data:i,processData:!1,contentType:!1,headers:{"X-File-Name":encodeURIComponent(e.name)},xhr:function(){var e,n;return(e=t.ajaxSettings.xhr())&&(e.upload.onprogress=(n=this,function(e){return n.progress(e)})),e},progress:(l=this,function(t){if(t.lengthComputable)return l.trigger("uploadprogress",[e,t.loaded,t.total])}),error:function(t){return function(n,i,o){return t.trigger("uploaderror",[e,n,i])}}(this),success:function(n){return function(i){return n.trigger("uploadprogress",[e,e.size,e.size]),n.trigger("uploadsuccess",[e,i]),t(document).trigger("uploadsuccess",[e,i,n])}}(this),complete:function(t){return function(n,i){return t.trigger("uploadcomplete",[e,n.responseText])}}(this)}),u},o.prototype.cancel=function(e){var t,n,i,o;if(!e.id)for(n=0,i=(o=this.files).length;n<i;n++)if((t=o[n]).id===1*e){e=t;break}return this.trigger("uploadcancel",[e]),e.xhr&&e.xhr.abort(),e.xhr=null},o.prototype.destroy=function(){var e,n,i,o;for(this.queue.length=0,n=0,i=(o=this.files).length;n<i;n++)e=o[n],this.cancel(e);return t(window).off(".uploader-"+this.id),t(document).off(".uploader-"+this.id)},o.i18n={"zh-CN":{leaveConfirm:"正在上传文件，如果离开上传会自动取消"}},o.locale="zh-CN",function(e){return new o(e)}});
//# sourceMappingURL=sourcemaps/uploader.js.map
